#!/bin/sh

#set the gateway dnsmasq delivers via dhcp leases and local routes

exec >/tmp/set_gateway.log 2>&1
. /sbin/freifunk_shared
date

echo "(I) set_gateway: start set_gateway"

local_gw=`cat /tmp/ff_local_gw 2> /dev/null`
mesh_gw=`cat /tmp/ff_mesh_gw 2> /dev/null`
own_mesh_ip=`get_ip br-mesh`
own_lan_ip=`get_ip br-lan`

echo "(I) set_gateway: local_gw: '$local_gw', mesh_gw: '$mesh_gw'"


[ -n "$mesh_gw" ] && mesh_str="121,0.0.0.0/0,$mesh_gw" || mesh_str="121,10.0.0.0/8,$own_mesh_ip"

#set gateway to annouce in lan and mesh

if [ -n "$local_gw" ]; then
  #we have internet

  share_internet=`uci get -q freifunk.settings.share_internet`
  [ "$share_internet" = "yes" ] && mesh_str="121,0.0.0.0/0,$own_mesh_ip"
else
  #we have no internet

  until_error "route del default"
  echo "search lan" > /tmp/resolv.conf.auto

  [ -n "$mesh_gw" ] && {
    route add default gw $mesh_gw
    echo "nameserver $mesh_gw" >> /tmp/resolv.conf.auto
  }
fi

uci set dhcp.mesh.dhcp_option="$mesh_str"
uci set dhcp.lan.dhcp_option="121,10.0.0.0/8,$own_lan_ip,0.0.0.0/0,$own_lan_ip"

/etc/init.d/dnsmasq restart

echo "(I) set_gateway: done"
