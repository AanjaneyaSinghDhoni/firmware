#!/bin/sh

#Get the IP of a node by MAC.
mac=$1
free=$2 #if set, get the first free IP instead

ff_subnet=`uci get -q freifunk.settings.ff_subnet`
debug=`uci get -q freifunk.settings.debug`

start_ip=`uci get dhcp.mesh.start`
end_ip=`uci get dhcp.mesh.limit`

#convert from locally to universally administered mac
#and a common mac format
fix_mac() {
    mac_in="$1"
    
    if [ ${#mac_in} -lt 8 ]; then
        return 1;
    fi
    
    mac_out=${mac_in%%:*}
    mac_out=$((0x$mac_out & 253))
    mac_out=`printf '%02x\n' $mac_out`
    mac_in="${mac_in#*:}"
    
    OIFS=$IFS
    IFS=':'
    
    for x in $mac_in; do
        n=$((0x$x))
        n=`printf '%02x\n' $n`
        mac_out="$mac_out:$n"
    done

    IFS=$OIFS
    echo $mac_out
}

mac=$(fix_mac $mac)


seed=0
for x in $(echo $mac | tr ":" "\n"); do
    seed=$((seed + 0x$x + (0x$x << 8) + (0x$x << 16)))
done

addr_t=$((start_ip + (seed % end_ip)))

#we try only ten times to not to spam the network
i=0
while [ $i -lt 10 ]
do
    addr_c=$(((addr_t & 0xff00) >> 8))
    addr_d=$(((addr_t & 0x00ff) >> 0))

    addr_ip="10.$ff_subnet.$addr_c.$addr_d"
    addr_mac=`arping -c 3 -f -I br-mesh $addr_ip | grep -m 1 -o -E '[[:xdigit:]]{1,2}(:[[:xdigit:]]{1,2}){5}'`
    addr_mac=$(fix_mac $addr_mac)

    if [ -n "$free" -a -z "$addr_mac" ]; then
        #found free ip based on given MAC :)
        echo $addr_ip
        exit 0
    fi
    
    if [ -z "$free" -a "$addr_mac" == "$mac" ]; then
        #found IP matching the given MAC :-)
        echo $addr_ip
        exit 0
    fi
    
    addr_t=$((addr_t+1))
    i=$((i + 1))
done

#IP not found :-(
exit 1
