#!/bin/sh

#Check for Internet access on the WAN port and switch
#batman-adv between client und server mode accordingly.

exec >/tmp/wan_watchdog.log 2>&1
date

echo "(I) wan_watchdog: start"

share_wan=`uci get freifunk.settings.share_wan`
echo "(I) wan_watchdog: share internet: '$share_wan'"

wan_interfaces=`uci -q get freifunk.settings.wan_interfaces`
wan_interface=${wan_interfaces%% *} #get first interface
echo "(I) wan_watchdog: wan interface: '$wan_interface'"

bat_mode=`uci -q get batman-adv.bat0.gw_mode`
echo "(I) wan_watchdog: current batman mode: '$bat_mode'"

mesh_ip=`ifconfig br-mesh | grep "inet addr" | awk 'BEGIN { FS=":" } { print $2 }'| awk '{ print $1 }'`

n2n=`which edge`
tinc=`which tincd`


has_internet()
{
    echo -n "no" > /tmp/ff_has_internet

    [ -z "$wan_interface" ] && {
      echo "(I) wan_watchdog: No wan interfaces found."
      return 1
    }

    [ -z "$mesh_ip" ] && {
      echo "(I) wan_watchdog: No mesh ip set."
      return 1
    }

    local wan_ip=`ifconfig $wan_interface | grep "inet addr" | awk 'BEGIN { FS=":" } { print $2 }'| awk '{ print $1 }'`
    [ -z "$wan_ip" ] && {
        echo "(I) wan_watchdog: No wan ip set."
        return 1
    }

    local gw=`route -n | sed  "/^0\.0\.0\.0.*$wan_interface$/!d" | awk '{ print $2; }'`
    [ -z "$gw" ] && {
        echo "(I) wan_watchdog: No gateway ip found."
        return 1
    }
    
    #various root servers
    IPCHECK="192.33.4.12 128.8.10.90 193.0.14.129 198.41.0.4 192.228.79.201 192.5.5.241 192.36.148.17 192.58.128.30"
    local r1 r2 ok
    for ip in $IPCHECK; do
        route add -host $gw dev $wan_interface; r1=$?;
        route add -host $ip gw $gw; r2=$?;
        ping $ip -c 1 -I $wan_interface -q -W 1 > /dev/null; ok=$?;
        [ $r2 -eq 0 ] && route del -host $gw dev $wan_interface
        [ $r1 -eq 0 ] && route del -host $ip gw $gw
        [ $ok -eq 0 ] && { echo -n "yes" > /tmp/ff_has_internet; return 0; }
    done
    echo "(E) wan_watchdog: Cannot reach any test IP."
    return 1
}

is_running() {
  ps | grep -v grep | grep "$1" > /dev/null
}

#switch to client
bat_client()
{
    if [ "$bat_mode" != "client" ]; then
        echo "(I) wan_watchdog: Switch to client mode."
        uci set batman-adv.bat0.gw_mode="client"
        batctl gw client
        /etc/init.d/nodogsplash stop > /dev/null
    else
        echo "(I) wan_watchdog: Already in client mode."
    fi
}

#switch to server
bat_server()
{
    if [ "$bat_mode" != "server" ]; then
        echo "(I) wan_watchdog: Switch to gateway mode."
        /etc/init.d/nodogsplash start > /dev/null
        
        uci set batman-adv.bat0.gw_mode="server"
        batctl gw server
    else
        echo "(I) wan_watchdog: Already in gateway mode."
    fi
}

if has_internet; then
    # we have internet
    /sbin/set_gateway "lan" "$mesh_ip"
    
    [ "$share_wan" = "yes" ] && bat_server || bat_client
    
    is_running "$n2n" || /etc/init.d/n2n start
    is_running "$tinc" || /etc/init.d/tinc start
else
    # we have no internet
    /sbin/set_gateway "lan" ""

    bat_client

    is_running "$n2n" && /etc/init.d/n2n stop
    is_running "$tinc" && /etc/init.d/tinc stop
fi

echo "(I) wan_watchdog: done"
