#!/bin/sh /etc/rc.common

START=19


start()
{
exec >/tmp/freifunk_init.log 2>&1
. /lib/functions.sh


if [ -f /etc/init.d/freifunk_setup ]; then
	echo "(I) Freifunk: Skip and wait for /etc/init.d/freifunk_setup to be run."
	exit
fi

echo "(I) Freifunk: start freifunk_init"


mac=`uci get -q freifunk.@settings[0].mac`
share_internet=`uci get -q freifunk.@settings[0].share_internet`
config_nets=`uci get -q freifunk.@settings[0].config_nets`

echo "(I) Freifunk: mac: '$mac'"
echo "(I) Freifunk: share_internet: '$share_internet'"
echo "(I) Freifunk: config_nets: '$config_nets'"


#Create dummy interfaces to be able to set the mac of
#br-mesh and the mac for the OGMs of batman-adv freely.
#Also, a bridge needs at least one interface.

echo "(I) Freifunk: Create dummy_mesh interface."
tunctl -t dummy_mesh > /dev/null

echo "(I) Freifunk: Create dummy_lan interface."
tunctl -t dummy_lan > /dev/null

echo "(I) Freifunk: Create dummy_bat interface."
tunctl -t dummy_bat > /dev/null


#add first interface to set originator mac
ifconfig dummy_bat hw ether $mac mtu 1528 up
batctl if add dummy_bat


ip=`mac2ip $mac`
echo "(I) Freifunk: Set IP for br-mesh to '$ip'."
uci set network.mesh.ipaddr="$ip"


uci delete -q firewall.freifunk_share
if [ "$share_internet" = "yes" ]; then
	#forward from mesh to wan
	uci set firewall.freifunk_share="forwarding"
	uci set firewall.freifunk_share.src="mesh"
	uci set firewall.freifunk_share.dest="wan"
fi

#query query_name match_value [get_other_value]
uci_query()
{
	local query=$1
	local value=$2
	local other=$3
	local i=0
	while true; do
		local q=${query/\?/$i}
		v=`uci $q 2> /dev/null`
		[ $? -ne 0 ] && return
		[ "$v"	= "$value" ] && {
			[ -n "$other" ] && echo `uci ${q%.*}.$other 2> /dev/null` || echo $i
			return
		}
		i=$(($i + 1))
	done
}

#filter ssh/https ports
for src in wan lan mesh; do
	default_target=`uci_query "-q get firewall.@zone[?].name" "$src" "input"`
	list_contains config_nets "$src" && target=ACCEPT || target=REJECT
	[ "$target" = "$default_target" ] && continue
	for port in 22 443; do
		s=firewall.`uci add firewall rule`
		uci set $s.src=$src
		uci set $s.dest_port=$port
		uci set $s.target=$target
		uci set $s.proto=tcp
	done
done


echo "(I) Freifunk: done freifunk_init"
}
