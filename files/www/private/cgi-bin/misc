#!/usr/bin/haserl
content-type: text/plain

<%
case $GET_func in
  reboot)
    reboot
    echo "(I) misc: Reboot now..."
  ;;
  mac2ip)
    /sbin/mac2ip "$GET_mac"
  ;;
  status)
    ip=`ifconfig br-mesh | grep "inet addr" | awk 'BEGIN { FS=":" } { print $2 }'| awk '{ print $1 }' `
    up=`uptime`
    load=${up##*:}
    uptime=${up%%,*}
    uptime=${uptime##*up}
    uname=`uname -s -m -r`
    date=`date`
    has_internet="no" && [ -s "/tmp/ff_local_gw" ]  && has_internet="yes"
    is_gateway=`uci -q get batman-adv.bat0.gw_mode`
    node_count=$((`batctl tg | grep '^ \*' | cut -b 33-49 | sort | uniq | wc -l`+1))
    neigh_count=`batctl o | grep '^[[:digit:]|[:lower:]]' | cut -b 37-53 | sort | uniq | wc -l`
    firmware_version=`uci -q get freifunk.@settings[0].version`
    tinc_version=`tincd --version 2>&1 | head -n1 | sed -n -r 's/.* ([0-9]*\.[0-9\.]*) .*/\1/p'`
    n2n_version=`edge --help 2>&1 | head -n1 | sed -n -r 's/.*(v[0-9\.]*).*/\1/p'`
    batman_version=`cat /sys/module/batman_adv/version 2> /dev/null`
    
    echo -n "{\"ip\" : \"$ip\", \"node_count\" : \"$node_count\", \"neigh_count\" : \"$neigh_count\", "\
"\"uptime\" : \"$uptime\", \"has_internet\" : \"$has_internet\", \"is_gateway\" : \"$is_gateway\", "\
"\"firmware_version\" : \"$firmware_version\", \"tinc_version\" : \"$tinc_version\", \"n2n_version\" : \"$n2n_version\", "\
"\"load\" : \"$load\", \"batman_version\" : \"$batman_version\", \"uname\" : \"$uname\", \"date\" : \"$date\"}"
  ;;
  *)
  echo "(E) misc: Invalid command: '$GET_func'"
  ;;
esac
%>
