#!/usr/bin/haserl
<%

case $GET_func in
  reboot)
    reboot
    echo "(I) misc: Reboot now..."
  ;;
  mac2ip)
    /sbin/mac2ip "$GET_mac"
  ;;
  status)
    uptime=`uptime`
    uname=`uname -a`
    has_internet="Yes"
    is_gateway="No"
    #share_internet="No"
    #other_gateway - knows other gateway?
    node_count=`batctl o | grep -c "^[0-9a-f]\{2\}:"`
    neigh_count=`batctl o | tail -n+3 | grep -v "^No" | tr -s ' ' | cut -d ' ' -f 4 | sort | uniq | wc -l`
    tinc_version=`tincd --version 2>&1 | head -n1 | sed -n -r 's/.* ([0-9]*\.[0-9\.]*) .*/\1/p'`
    n2n_version=`edge --help 2>&1 | head -n1 | sed -n -r 's/.*(v[0-9\.]*).*/\1/p'`
    batman_version=`batctl -v 2>&1 | head -n1 | sed -n -r 's/.*batman-adv: ([0-9\.]*).*/\1/p'`
    
    echo -n "{\"node_count\" : \"$node_count\", \"neigh_count\" : \"$neigh_count\","\
"\"uptime\" : \"$uptime\", \"has_internet\" : \"$has_internet\", \"is_gateway\" : \"$is_gateway\","\
"\"tinc_version\" : \"$tinc_version\", \"n2n_version\" : \"$n2n_version\","\
"\"batman_version\" : \"$batman_version\", \"uname\" : \"$uname\"}"
  ;;
  *)
  echo "(E) misc: Invalid command: '$GET_func'"
  ;;
esac
%>
