#!/usr/bin/haserl
<%

case $POST_func in
    get_config)
        echo -n "{"
        i=0
        while [ `uci get -q n2n.@edge[$i]` ]
        do
            supernode=`uci -q get n2n.@edge[$i].supernode`
            port=`uci -q get n2n.@edge[$i].port`
            community=`uci -q get n2n.@edge[$i].community`
            key=`uci -q get n2n.@edge[$i].key`

            [ $i -gt 0 ] && echo -n ", "
            echo -n "\"entry_$i\" : { \"supernode\":\"$supernode\", \"port\":\"$port\", \"community\":\"$community\", \"key\":\"$key\"}"

            i=$(($i+1))
        done
        echo "}"
    ;;
    del_config)
        id=`echo "$POST_id" | sed -n -r 's/entry_([[:digit:]]+)/\1/p'` 
        uci -q delete n2n.@edge[$id] &> /dev/null
        if [ $? -eq 0 ]; then
            echo "(I) N2N: Setting '$id' deleted."
        else
            echo "(E) N2N: Could not delete setting '$id'."
        fi
    ;;
    add_config)
        uci -q add n2n edge &> /dev/null
        if [ $? -eq 0 ]; then
            echo "(I) N2N: Added section."
        else
            echo "(E) N2N: Could not create section."
        fi
    ;;
    set_config)
        id=`echo "$POST_id" | sed -n -r 's/entry_([[:digit:]]+)/\1/p'`
        supernode="$POST_supernode"
        port="$POST_port"
        community="$POST_community"
        key="$POST_key"

        if [ `uci get -q n2n.@edge[$id]` -eq 1 ]; then
          echo "(E) N2N: Invalid setting number '$id'"
          exit
        fi

        uci -q set n2n.@edge[$id].ipaddr="0.0.0.0"
        uci -q set n2n.@edge[$id].supernode="$supernode"
        uci -q set n2n.@edge[$id].port="$port"
        uci -q set n2n.@edge[$id].community="$community"
        uci -q set n2n.@edge[$id].key="$key"
        uci -q set n2n.@edge[$id].route=""
        uci -q set n2n.@edge[$id].mtu=1528

        if [ $? -eq 0 ]; then
          echo "(I) N2N: Setting '$id' set."
        else
          echo "(E) N2N: Could not set setting '$id'."
        fi
    ;;
    save_config)
      uci -q commit n2n
      if [ $? -eq 0 ]; then
        echo "(I) N2N: Settings saved."
      else
        echo "(E) N2N: Could not save settings."
      fi
    ;;
    get_version)
        edge --help | head -n1 | sed -n -r 's/.*(v[0-9\.]*).*/\1/p'
    ;;
    *)
      echo "(E) N2N: '$POST_func' not implemented."
    ;;
esac
%>
