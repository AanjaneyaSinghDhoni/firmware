#!/bin/sh

echo Content-type: text/html
echo ""

cat <<EOF
<!DOCTYPE html>
<html>
<head>
<title>Info</title>
<meta charset="utf-8"/>
<style type="text/css">
* {
    margin: 0;
}

html, body {
    height: 98%;
}

#header {
	margin:1%;
}

#footer {
    position: absolute;
    bottom: 1%;
    left: 1%;
    right: 1%;
    width: 98%;
}
</style>
</head>
<body>
<div id="header">
<b>Name des Knoten: </b>
$(uci get system.@system[0].hostname)
<br />
<b>Eigene IPv4-Adresse: </b>
$(ip -4 address show dev br-public 2> /dev/null | sed -rn 's/.*inet6? (.*[^:])\/.*/\1/p' | head -1)
<br />
<b>Eigene IPv6-Adresse: </b>
$(ip -6 address show dev br-public 2> /dev/null | sed -rn 's/.*inet6? (.*[^:])\/.*/\1/p' | head -1)
<br />
<b>Anzahl bekannter Knoten: </b>
$(echo $((`batctl tg | grep '^ \*' | cut -b 33-49 | sort | uniq | wc -l 2> /dev/null`+1)))
<br />
<b>Anzahl benachbarter Knoten: </b>
$(batctl o | grep '^[[:digit:]|[:lower:]]' | cut -b 37-53 | sort | uniq | wc -l)
<br /><br />
<b>Liste bekannter Gateways: </b>
<br /><br />
<ul>
EOF

gw_addr=$(ip -4 route list 0/0 dev br-public 2> /dev/null | awk '{print($3)}')

IFS="
"
for addr in $(alfred -r 88 | tr '{}[]\n"\\,' ' ' | awk 'BEGIN{c=0}{ if($4 == "gateway" && $7 ~ /^[0-9.]+$/) {print($7); if(c>9) exit(0)}; c++;}'  2> /dev/null); do
	[ "$gw_addr" = "$addr" ] && ext=" (aktueller default)" || ext=""
	echo "<li><a href='http://$addr'>$addr</a>$ext</li>"
	found="yes"
done

if [ -z "$found" ]; then
	echo "<li>Kein Gateway gefunden</li>"
fi

cat <<EOF
</ul>
</div>

<div id="footer">
    <span style="float: left;"><a href="#" id="link">Login</a></span>
    <span style="float: right;"><a href="http://www.freifunk-bielefeld.de/">FFB Firmware</a> v$(uci get -q freifunk.@settings[0].version || echo "???")</span>
</div>

<script type="text/javascript">
document.getElementById("link").href="https://"+location.host;
</script>

</body>
</html>
EOF
